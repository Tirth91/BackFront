<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agora Debug Call with Grid</title>
  <style>
    body { background: #111; color: white; text-align: center; font-family: sans-serif; margin: 0; padding: 20px; }
    h1 { color: #0f0; }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin: 10px;
      background: #0f0;
      border: none;
      color: #111;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #0c0; }
    #status { margin-bottom: 10px; color: #0f0; }

    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      max-width: 1000px;
      margin: auto;
    }

    .video-box {
      background: #000;
      border: 2px solid #0f0;
      border-radius: 8px;
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      overflow: hidden;
    }

    .video-box video, .video-stream {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .label {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.6);
      color: #0f0;
      padding: 6px;
      font-size: 0.9rem;
    }

    #log {
      text-align: left;
      margin-top: 20px;
      background: #222;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <h1>ðŸ§ª Agora Video Debug</h1>
  <div id="status">Not joined</div>

  <button onclick="joinCall()">Join Call</button>
  <button onclick="leaveCall()">Leave Call</button>

  <div id="video-grid">
    <!-- Local and remote videos will appear here -->
  </div>

  <div id="log"></div>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <script>
    const APP_ID = "0f3fde8ae17c4048bcfc8d69286bc851";
    const CHANNEL = "test";
    const TOKEN = null;

    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localTrack;
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const grid = document.getElementById("video-grid");

    function log(...args) {
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(" ");
      console.log(...args);
      logEl.innerHTML += `<div>${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function createVideoBox(id, label) {
      const box = document.createElement("div");
      box.className = "video-box";
      box.id = `box-${id}`;

      const container = document.createElement("div");
      container.className = "video-stream";
      container.id = id;

      const tag = document.createElement("div");
      tag.className = "label";
      tag.id = `label-${id}`;
      tag.textContent = label;

      box.appendChild(container);
      box.appendChild(tag);
      grid.appendChild(box);
    }

    async function joinCall() {
      log("Joining with APP_ID:", APP_ID, "CHANNEL:", CHANNEL);
      try {
        await client.join(APP_ID, CHANNEL, TOKEN, null);
        log("Successfully joined Agora channel");
        statusEl.textContent = "Joined";

        localTrack = await AgoraRTC.createCameraVideoTrack();
        createVideoBox("local", "You");
        await localTrack.play("local");
        await client.publish([localTrack]);

        client.on("user-published", async (user, mediaType) => {
          log("User published:", user.uid, "type:", mediaType);
          await client.subscribe(user, mediaType);
          if (mediaType === "video") {
            const remoteId = `remote-${user.uid}`;
            createVideoBox(remoteId, `User ${user.uid}`);
            user.videoTrack.play(remoteId);
            log("Remote video started:", remoteId);
          }
        });

        client.on("user-unpublished", (user) => {
          const box = document.getElementById(`box-remote-${user.uid}`);
          if (box) box.remove();
        });

      } catch (err) {
        log("Join error:", err);
        statusEl.textContent = "Join failed: " + err.message;
      }
    }

    async function leaveCall() {
      try {
        await client.leave();
        if (localTrack) {
          localTrack.stop();
          localTrack.close();
        }
        grid.innerHTML = "";
        statusEl.textContent = "Left call";
        log("Left the channel");
      } catch (err) {
        log("Leave error:", err);
      }
    }
  </script>
</body>
</html>