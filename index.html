<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora Group Call</title>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f4f4;
    }

    h2 {
      margin-bottom: 10px;
    }

    #controls {
      margin-bottom: 10px;
    }

    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 10px;
    }

    .video-box {
      background: #000;
      width: 100%;
      aspect-ratio: 4 / 3;
      position: relative;
      border-radius: 10px;
      overflow: hidden;
    }
  </style>
</head>
<body>

  <h2>Agora Zoom-Style Video Call</h2>

  <div id="controls">
    <input id="channel" type="text" placeholder="Enter Channel Name" />
    <button onclick="join()">Join</button>
    <button onclick="leave()">Leave</button>
  </div>

  <div id="video-grid"></div>

  <script>
    const APP_ID = "0f3fde8ae17c4048bcfc8d69286bc851"; // Replace this with your Agora App ID
    const TOKEN = null; // Use a token only if your app needs it
    let CHANNEL = "";

    let client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localTracks = { videoTrack: null, audioTrack: null };
    let localUid = null;
    const remoteUsers = {};

    async function join() {
      CHANNEL = document.getElementById("channel").value;
      if (!CHANNEL) return alert("Enter a channel name");

      await client.join(APP_ID, CHANNEL, TOKEN, null);

      localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
      localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();

      localUid = client.uid;
      addVideoBox(localUid, true);
      localTracks.videoTrack.play(`user-${localUid}`);

      await client.publish(Object.values(localTracks));
      console.log("Published local tracks");

      client.on("user-published", handleUserPublished);
      client.on("user-unpublished", handleUserUnpublished);
      client.on("user-left", handleUserLeft);
    }

    async function leave() {
      for (let trackName in localTracks) {
        const track = localTracks[trackName];
        if (track) {
          track.stop();
          track.close();
        }
      }

      await client.leave();
      document.getElementById("video-grid").innerHTML = "";
      console.log("Left channel");
    }

    function addVideoBox(uid, isLocal = false) {
      if (document.getElementById(`user-${uid}`)) return;
      const box = document.createElement("div");
      box.id = `user-${uid}`;
      box.className = "video-box";
      document.getElementById("video-grid").appendChild(box);
    }

    function removeVideoBox(uid) {
      const el = document.getElementById(`user-${uid}`);
      if (el) el.remove();
    }

    async function handleUserPublished(user, mediaType) {
      await client.subscribe(user, mediaType);
      console.log("Subscribed to user:", user.uid);

      addVideoBox(user.uid);

      if (mediaType === "video") {
        user.videoTrack.play(`user-${user.uid}`);
      }

      if (mediaType === "audio") {
        user.audioTrack.play();
      }

      remoteUsers[user.uid] = user;
    }

    function handleUserUnpublished(user) {
      removeVideoBox(user.uid);
    }

    function handleUserLeft(user) {
      removeVideoBox(user.uid);
      delete remoteUsers[user.uid];
    }
  </script>

</body>
</html>
