<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agora + Gesture Recognition</title>
  <style>
    body { background: #111; color: white; text-align: center; font-family: sans-serif; margin: 0; padding: 20px; }
    h1 { color: #0f0; }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin: 10px;
      background: #0f0;
      border: none;
      color: #111;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #0c0; }
    #status { margin-bottom: 10px; color: #0f0; }

    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      max-width: 1000px;
      margin: auto;
    }

    .video-box {
      background: #000;
      border: 2px solid #0f0;
      border-radius: 8px;
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      overflow: hidden;
    }

    .video-box video, .video-stream {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .label {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.6);
      color: #0f0;
      padding: 6px;
      font-size: 0.9rem;
    }

    #log {
      text-align: left;
      margin-top: 20px;
      background: #222;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    #hidden-cam { display: none; }
  </style>
</head>
<body>
  <h1>üñêÔ∏è Agora + Gesture Recognition</h1>
  <div id="status">Not joined</div>

  <button onclick="joinCall()">Join Call</button>
  <button onclick="leaveCall()">Leave Call</button>

  <video id="hidden-cam" autoplay playsinline muted></video>
  <div id="video-grid"></div>
  <div id="log"></div>

  <!-- Agora + Gesture scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <script>
    const APP_ID = "0f3fde8ae17c4048bcfc8d69286bc851";
    const CHANNEL = "test";
    const TOKEN = null;
    const labelMap = ["1L", "1R", "2L", "2R", "3L", "3R", "4L", "4R", "5R", "6L", "6R", "7L", "7R", "8L", "8R", "9L", "9R", "A", "B", "C", "D", "L"];
    const CONFIDENCE_THRESHOLD = 0.7;

    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const grid = document.getElementById("video-grid");
    const hiddenVideo = document.getElementById("hidden-cam");

    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localTrack, dataStreamId, model;

    function log(...args) {
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(" ");
      console.log(...args);
      logEl.innerHTML += `<div>${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function createVideoBox(id, label) {
      const box = document.createElement("div");
      box.className = "video-box";
      box.id = `box-${id}`;

      const container = document.createElement("div");
      container.className = "video-stream";
      container.id = id;

      const tag = document.createElement("div");
      tag.className = "label";
      tag.id = `label-${id}`;
      tag.textContent = label;

      box.appendChild(container);
      box.appendChild(tag);
      grid.appendChild(box);
    }

    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    hands.setOptions({
      maxNumHands: 2,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });
    hands.onResults(handleResults);

    function extractLandmarks(results) {
      let landmarks = [];
      for (let i = 0; i < 2; i++) {
        if (results.multiHandLandmarks[i]) {
          for (let lm of results.multiHandLandmarks[i]) {
            landmarks.push(lm.x, lm.y, lm.z);
          }
        } else {
          for (let j = 0; j < 21; j++) {
            landmarks.push(0, 0, 0);
          }
        }
      }
      while (landmarks.length < 188) landmarks.push(0);
      return landmarks;
    }

    function handleResults(results) {
      if (!model) return;
      const landmarks = extractLandmarks(results);
      if (landmarks.some(v => v !== 0)) {
        const input = tf.tensor2d([landmarks]);
        const prediction = model.predict(input);
        prediction.array().then(probs => {
          const values = probs[0];
          const maxProb = Math.max(...values);
          const maxIndex = values.indexOf(maxProb);
          const label = maxProb >= CONFIDENCE_THRESHOLD ? labelMap[maxIndex] : "No gesture";
          document.getElementById("label-local").textContent = `You: ${label}`;
          if (dataStreamId) client.sendStreamMessage(dataStreamId, label);
        });
        input.dispose();
        prediction.dispose();
      }
    }

    async function joinCall() {
      log("Joining with APP_ID:", APP_ID);
      model = await tf.loadLayersModel("landmark_model_tfjs/model.json");
      log("Model loaded");

      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      hiddenVideo.srcObject = stream;

      const camera = new Camera(hiddenVideo, {
        onFrame: async () => await hands.send({ image: hiddenVideo }),
        width: 640,
        height: 640
      });
      camera.start();

      await client.join(APP_ID, CHANNEL, TOKEN, null);
      localTrack = await AgoraRTC.createCameraVideoTrack();
      createVideoBox("local", "You");
      await localTrack.play("local");
      await client.publish([localTrack]);
      dataStreamId = await client.createDataStream({ reliable: true, ordered: true });

      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        if (mediaType === "video") {
          const id = `remote-${user.uid}`;
          createVideoBox(id, `User ${user.uid}`);
          user.videoTrack.play(id);
        }
      });

      client.on("stream-message", (uid, message) => {
        const label = document.getElementById(`label-remote-${uid}`);
        if (label) label.textContent = `User ${uid}: ${message}`;
      });

      client.on("user-unpublished", (user) => {
        const box = document.getElementById(`box-remote-${user.uid}`);
        if (box) box.remove();
      });

      statusEl.textContent = "Joined";
    }

    async function leaveCall() {
      await client.leave();
      if (localTrack) {
        localTrack.stop();
        localTrack.close();
      }
      const hiddenCamStream = hiddenVideo.srcObject;
      if (hiddenCamStream) {
        hiddenCamStream.getTracks().forEach(track => track.stop());
        hiddenVideo.srcObject = null;
      }
      grid.innerHTML = "";
      statusEl.textContent = "Left call";
    }
  </script>
</body>
</html>
