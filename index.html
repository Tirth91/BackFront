<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agora Test Call</title>
  <style>
    body { background: #111; color: white; text-align: center; font-family: sans-serif; }
    video { width: 320px; height: 240px; border: 2px solid #0f0; margin: 10px; }
    #log { background: #222; padding: 10px; margin-top: 10px; text-align: left; max-height: 200px; overflow-y: scroll; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Agora Video Call Debug</h1>
  <p>Status: <span id="status">Not joined</span></p>

  <button onclick="joinCall()">Join Call</button>
  <button onclick="leaveCall()">Leave Call</button>

  <div>
    <h3>Local</h3>
    <div id="local-player"></div>
  </div>

  <div>
    <h3>Remote</h3>
    <div id="remote-player"></div>
  </div>

  <div id="log"></div>

  <!-- Agora SDK -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <script>
    const APP_ID = "0f3fde8ae17c4048bcfc8d69286bc851";
    const CHANNEL = "test";
    const TOKEN = null;

    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localTrack;
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");

    function log(...args) {
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(" ");
      console.log(...args);
      logEl.innerHTML += `<div>${msg}</div>`;
    }

    async function joinCall() {
      log("Joining with APP_ID:", APP_ID, "CHANNEL:", CHANNEL);
      try {
        await client.join(APP_ID, CHANNEL, TOKEN, null);
        log("Successfully joined Agora channel");
        statusEl.textContent = "Joined";

        localTrack = await AgoraRTC.createCameraVideoTrack();
        await localTrack.play("local-player");
        await client.publish([localTrack]);

        client.on("user-published", async (user, mediaType) => {
          log("User published:", user.uid, "type:", mediaType);
          await client.subscribe(user, mediaType);
          if (mediaType === "video") {
            const remoteId = `remote-${user.uid}`;
            const remoteDiv = document.createElement("div");
            remoteDiv.id = remoteId;
            document.getElementById("remote-player").appendChild(remoteDiv);
            user.videoTrack.play(remoteId);
            log("Remote video started:", remoteId);
          }
        });
      } catch (err) {
        log("Join error:", err);
        statusEl.textContent = "Join failed: " + err.message;
      }
    }

    async function leaveCall() {
      try {
        await client.leave();
        if (localTrack) {
          localTrack.stop();
          localTrack.close();
        }
        document.getElementById("local-player").innerHTML = "";
        document.getElementById("remote-player").innerHTML = "";
        statusEl.textContent = "Left call";
        log("Left the channel");
      } catch (err) {
        log("Leave error:", err);
      }
    }
  </script>
</body>
</html>